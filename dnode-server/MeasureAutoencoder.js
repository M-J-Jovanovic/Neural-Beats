//jm150231d
/*
MeasureAutoencoder 1.0 - ova klasa ucitava dekoder i koristi ga da prevodi podatke iz generatora u nesto sto lici na MIDI i moze da se igra u brauzeru
*/
'use strict'

const internal = {};
const tfjs = require('./node_modules/@tensorflow/tfjs-node');
let decoder=null;
let _decoder_path=null;
const math=require("./node_modules/mathjs");

module.exports = internal.MeasureAutoencoder = class {
	/*
	konstruktor, cuva put do mozga
	*/
    constructor(decoder_path) {_decoder_path=decoder_path;}
	/*
	prevodi muziku iz unutrasnjeg formata LSTM'a u citljiv format
	*/
    async decode(measure){
        if(null==decoder){
            decoder = await tfjs.loadLayersModel(_decoder_path);
        }
        measure=tfjs.tensor2d(measure,[1,512]);
        let decoded=await decoder.predict(measure);
        decoded=await decoded.data();
        decoded=Array.prototype.slice.call(decoded);
        decoded=math.reshape(decoded,[512,5]);
        decoded=decoded.filter(function(value){
            return value[3]+value[4]>=16/256;
        });
        decoded.sort(function(a,b){
            if (a[0]<b[0]) return -1;
            else if(a[0]>b[0]) return 1;
            else return 0;
        });
        let scaler=1/decoded[decoded.length-1][0];
        for(let i=0;i<decoded.length;i++){
            decoded[i][0]=Math.round(decoded[i][0]*1920*scaler);
            decoded[i][1]=Math.floor(decoded[i][1]*32);
            decoded[i][2]=Math.ceil(decoded[i][2]*960*scaler);
            decoded[i][3]=Math.floor(decoded[i][3]*256);
            decoded[i][4]=Math.floor(decoded[i][4]*256);
        }
        //console.log(decoded);
        return decoded;
    }
}


//let measuredecoder=new internal.MeasureAutoencoder("file://C:/Users/Mashallah/PycharmProjects/exporter/decoder/model.json");
//measuredecoder.decode(tfjs.tensor2d([0.4241635, 0.51014614, 0.3074873, 0.9498465, 0.3828311, 0.35692847, 0.32462132, 0.42842394, 0.42767355, 0.3937855, 0.49550435, 0.29199153, 0.38587648, 0.19887704, 0.37343097, 0.42963666, 0.1302191, 0.38736498, 0.4983721, 0.37019926, 0.40559718, 0.38077176, 0.48690185, 0.26699653, 0.4229455, 0.6252167, 0.67426515, 0.3507853, 0.5992745, 0.3144517, 0.12335032, 0.6551027, 0.3638757, 0.47318864, 0.49339843, 0.29525656, 0.39644977, 0.30684325, 0.34445968, 0.44750893, 0.41465312, 0.52372396, 0.46560133, 0.31167752, 0.5133448, 0.38171166, 0.39573407, 0.36094254, 0.4084988, 0.7779822, 0.2933774, 1.1920929e-06, 0.46046087, 0.381154, 0.35287374, 0.37140197, 0.4013738, 0.49166194, 0.334307, 0.4632135, 0.39235184, 0.47597197, 0.59418684, 0.32314724, 0.1741147, 0.3396492, 0.21889111, 0.9983517, 0.20517436, 0.3359815, 0.06373495, 0.43869787, 0.38923892, 0.5957047, 0.30943197, 0.54244864, 0.38868505, 0.4316702, 0.7196501, 0.32873547, 0.9895605, 0.51218545, 0.21942016, 0.3331191, 0.27757233, 0.43530813, 0.65256506, 0.35332394, 0.5769924, 0.39621574, 0.3990545, 0.50318134, 0.41390368, 0.24630803, 0.41488475, 0.3652261, 0.33062652, 0.3053109, 0.30965817, 0.26121366, 0.33527428, 0.4667749, 0.52304476, 0.30984443, 0.15528622, 0.54338306, 0.37295413, 0.32487255, 0.2985407, 0.2726472, 0.22421145, 0.22037551, 0.45717642, 0.6036895, 0.3662665, 0.4406978, 0.3067235, 0.6446562, 0.32768437, 0.29937097, 0.46060205, 0.49679372, 0.20082137, 0.37974307, 0.2711987, 0.35246447, 0.44382903, 0.48965836, 0.3622651, 0.33082396, 0.4921561, 0.017169923, 0.36473846, 0.3611288, 0.4797462, 0.47677645, 0.24935272, 0.42717946, 0.33767113, 0.41498652, 0.36464116, 0.26925188, 0.82908344, 0.36294276, 0.3325024, 0.3812109, 0.47838694, 0.36411712, 0.37342682, 0.43343505, 0.49982294, 0.3794089, 0.31318188, 0.32106066, 0.2550305, 0.2598261, 0.24969116, 0.6203974, 0.60768026, 0.30168366, 0.29489535, 0.265292, 0.36054683, 0.49236542, 0.49344125, 0.3845532, 0.40473154, 0.36203372, 0.3694138, 0.3127854, 0.42956123, 0.27599323, 0.68982464, 0.34195825, 0.29665196, 0.3669348, 0.44505888, 0.30841976, 0.00555107, 0.5552027, 0.44713357, 0.40627003, 0.48567837, 0.6368144, 0.3281461, 0.39008018, 0.29393658, 0.3544139, 0.46038932, 0.3029907, 0.20422244, 0.5761585, 0.38889223, 0.2862399, 0.30431953, 0.11032942, 0.5011542, 0.33149594, 0.34625253, 0.40117207, 0.39002752, 0.40360382, 0.34567016, 0.253785, 0.4068907, 0.33316368, 0.40846512, 0.4593256, 0.34705597, 0.183642, 0.46254525, 0.9800836, 0.38838094, 0.098703176, 0.29290703, 0.46550584, 0.028846383, 0.3653854, 0.40410352, 0.2276268, 0.46058658, 0.08646658, 0.44282505, 0.40853468, 0.68501735, 0.6930515, 0.36756706, 0.32922328, 0.31449842, 0.3088565, 0.3529096, 0.39606383, 0.36112803, 0.9869071, 0.27839506, 0.041337818, 0.40132654, 0.5076354, 0.38491148, 0.31684497, 0.23902977, 0.42160547, 0.12456021, 0.3038274, 0.24127388, 0.46893242, 0.39007738, 0.32354537, 0.54925334, 0.4190659, 0.44331348, 0.17390782, 0.27577853, 0.4393858, 0.2926876, 0.36848593, 0.3085658, 0.43657455, 0.333664, 0.09052992, 0.44351605, 0.41597277, 0.21407902, 0.83566034, 0.2541242, 0.19351348, 0.374969, 0.60108, 0.32470316, 0.475546, 0.6575194, 0.23650417, 0.1019097, 0.27613437, 0.04951507, 0.23823127, 0.24266654, 0.23802447, 0.004203975, 0.3716292, 0.37434095, 0.24828094, 0.30753362, 0.5020488, 0.073622316, 0.32162464, 0.567714, 0.5387134, 0.54449135, 0.36599347, 0.52907234, 0.9769841, 0.3595764, 0.4325623, 0.12387848, 0.3045367, 0.64049965, 0.32880595, 0.29763144, 0.35866222, 0.42784327, 0.32155794, 0.37335965, 0.40923998, 0.46393457, 0.52408636, 0.42702252, 0.38520926, 0.026144832, 0.36801133, 0.52617323, 0.2818401, 0.4897131, 0.15801841, 0.41930526, 0.52112836, 0.6899363, 0.3698825, 0.36679256, 0.5734485, 0.5769649, 0.29441777, 0.20638108, 0.48296955, 0.36932945, 0.29511714, 0.62399924, 0.39926115, 0.24146569, 0.4026223, 0.27325284, 0.3721618, 0.44385028, 0.34940553, 0.2373544, 0.02106908, 0.39010137, 0.39190364, 0.43874353, 0.29534343, 0.25237352, 0.3043584, 0.48281482, 0.49546972, 0.050052285, 0.39710355, 0.43844572, 0.23614004, 0.38063756, 0.42813835, 0.42777428, 0.27050585, 0.34597495, 0.29448986, 0.029443145, 0.35349727, 0.4059734, 0.48654315, 0.26216415, 0.00029233098, 0.45959553, 0.4115106, 0.33467084, 0.41119462, 0.28247398, 0.33671302, 0.6015149, 0.31728715, 0.2266742, 0.43286324, 0.43396252, 0.7714298, 0.38305, 0.13440946, 0.19832551, 0.35813603, 0.22924918, 0.38143107, 0.27295536, 0.33717027, 0.38270977, 0.6723186, 0.26042956, 0.4011227, 0.4441184, 0.23563385, 0.5061332, 0.2907743, 0.29256344, 0.3272081, 0.20969397, 0.3083846, 0.89414424, 0.3508687, 0.43069282, 0.59308577, 0.4262685, 0.56533635, 0.39884055, 0.14137831, 0.45930672, 0.37508804, 0.21149233, 0.51395106, 0.84665084, 0.2615189, 0.4198164, 0.3084994, 0.4461079, 0.39932168, 0.0010826588, 0.43026572, 0.33788192, 0.24061975, 0.05443722, 0.23366702, 0.43541697, 0.019418746, 0.53699875, 0.4915195, 0.5173021, 0.27537757, 0.4285758, 0.32723182, 0.04129803, 0.40331924, 0.36520344, 0.44637546, 0.28057978, 0.2635851, 0.4970283, 0.44979966, 0.47478127, 0.3344906, 0.55255926, 0.4824989, 0.037163407, 0.3286646, 0.45796052, 0.3343891, 0.4265459, 0.9262097, 0.40295893, 0.28216028, 0.27227163, 0.36164182, 0.6558425, 0.02746895, 0.12920728, 0.22425953, 0.38090202, 0.4824484, 0.4277707, 0.26901227, 0.4147876, 0.3179327, 0.34520203, 0.24342841, 0.45651406, 0.3521508, 0.5659359, 0.3654459, 0.17386442, 0.37294942, 0.6542237, 0.03368795, 0.35545573, 0.40127304, 0.45295855, 0.04473242, 0.23991367, 0.34605163, 0.47414318, 0.39249745, 0.38320953, 0.6337218, 0.09076136, 0.27830595, 0.42723987, 0.30457753, 0.44537926, 0.37482548, 0.16077232, 0.23440066, 0.30777615, 0.44414654, 0.392246, 0.34971136, 0.6091953, 0.03860399, 0.21994376, 0.3457834, 0.029906392, 0.38463846, 0.41213784, 0.48868096, 0.7235855, 0.35355902, 0.049793243, 0.50778615, 0.31324226, 0.3270707, 0.68180776, 0.09723872, 0.080720246, 0.26637247, 0.55839086, 0.52266103, 0.34241426, 0.44400764, 0.409702, 0.53205085],[1,512]));